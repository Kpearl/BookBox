<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="BooklogMapper">
	
	<resultMap id="booklogSelectMap" type="booklog">
		<result property="booklogNo" column="booklog_no" jdbcType="VARCHAR"/>
		<result property="booklogName" column="booklog_name" jdbcType="VARCHAR"/>
		<result property="booklogImage" column="booklog_image" jdbcType="VARCHAR"/>
		<result property="booklogIntro" column="booklog_intro" jdbcType="VARCHAR"/>
		<association property="user" javaType="user">
			<result property="email" column="email" jdbcType="VARCHAR"/>
			<result property="nickname" column="nickname" jdbcType="VARCHAR"/>
		</association>
		<collection property="postingList" ofType="posting" column="posting_no">
			<result property="postingNo" column="posting_no" jdbcType="INTEGER"/>
			<result property="postingTitle" column="posting_title" jdbcType="VARCHAR"/>
			<result property="postingContent" column="posting_content" jdbcType="VARCHAR"/>
			<result property="postingRegDate" column="posting_reg_date" jdbcType="DATE"/>
			<result property="postingUpdateDate" column="posting_update_date" jdbcType="DATE"/>
			<association property="user" javaType="user">
				<result property="email" column="posting_email"/>
				<result property="nickname" column="posting_nickname"/>
			</association>
			<collection property="postingFileList" ofType="String" column="upload_no" select="selectPostingFileList"/>
			<collection property="postingLocationList" ofType="location" column="location_no">
				<result property="locationName" column="location_name" jdbcType="VARCHAR"/>
				<result property="locationLatitude" column="latitude" jdbcType="FLOAT"/>
				<result property="locationLongitude" column="longitude" jdbcType="FLOAT"/> 
			</collection>
		</collection>
		<collection property="bookmarkList" ofType="user" column="email">
			<result property="email" column="bookmark_email" jdbcType="VARCHAR"/>		
			<result property="nickname" column="bookmark_nickname" jdbcType="VARCHAR"/>
		</collection>
	</resultMap>
	
	
	<update id="updateBooklog" parameterType="booklog">
		UPDATE user
		<set>
			booklog_name = #{booklogName},
			<if test="booklogImage != null">
				booklog_image = #{booklogImage},
			</if>
			booklog_intro = #{booklogIntro}
		</set>
		WHERE
			booklog_no = #{booklogNo}
	</update>
	
	
	<select id="getBooklog" parameterType="booklog" resultMap="booklogSelectMap">
		SELECT
			u.email, u.nickname, u.booklog_name, u.booklog_image, u.booklog_intro, u.booklog_no,
			p.posting_no, p.posting_title, p.posting_content, 
			l.location_name, l.latitude, l.longitude, 
			bu.email bookmark_email, bu.nickname bookmark_nickname
		FROM
			user u
			LEFT OUTER JOIN posting p ON u.email = p.email
			LEFT OUTER JOIN location l ON p.posting_no = l.posting_no
			LEFT OUTER JOIN (<include refid="tagWiring"/>) tw ON p.posting_no = tw.target_no
			LEFT OUTER JOIN bookmark b ON u.email = b.email
			LEFT OUTER JOIN user bu ON b.target_email = bu.email
		<where>
			<if test="user != null">
				u.email = #{user.email}
			</if>
			<if test="booklogNo != 0">
				AND u.booklog_no = #{booklogNo}
			</if>
			 AND (bu.active = 1 OR bu.active IS NULL) AND (p.active = 1 OR p.active IS NULL)
		</where>
		ORDER BY
			p.posting_no DESC
	</select>
	
	<select id="getBooklogList" parameterType="search" resultMap="booklogSelectMap">
		SELECT
			u.email, u.nickname, u.booklog_name, u.booklog_image, u.booklog_intro, u.booklog_no, @rnum:=@rnum+1
		FROM
			user u
			<if test="condition == 'main'">
				LEFT OUTER JOIN (<include refid="viewCount"/>) vc ON u.booklog_no = vc.target_no
			</if>
			<if test="condition == 'bookmark'">
				LEFT OUTER JOIN bookmark b ON u.email = b.target_email
			</if>
			, (SELECT @rnum:=0) TMP
		<where>
			<if test="condition == 'main'">
				@rnum <![CDATA[<]]> 10
			</if>
			<if test="condition == 'nickname'">
				AND u.nickname LIKE '%${keyword}%'
			</if>
			<if test="condition == 'bookmark'">
				AND b.email = #{keyword}
			</if>
			AND u.active=1
		</where>
		<if test="condition == 'main'">
			ORDER BY vc.count DESC
		</if>
	</select>
	
	<insert id="addBookmark" parameterType="map">
		INSERT
		INTO bookmark( email, target_email )
		VALUES( #{user.email}, #{booklog.user.email} )
	</insert>
	
	<delete id="deleteBookmark" parameterType="map">
		DELETE
		FROM bookmark
		WHERE email = #{user.email} AND target_email = #{booklog.user.email}
	</delete>
	
	<select id="getBookmark" parameterType="map" resultType="String">
		SELECT
			email
		FROM
			bookmark
		WHERE
			email = #{user.email} AND target_email = #{booklog.user.email}
	</select>
	
	<select id="getDailyVisitors" parameterType="int" resultType="map">
		SELECT
			num, COUNT(reg_date) daycount
		FROM
			( SELECT date(current_date()-(@n:=@n+1)) date, @rnum:=@rnum+1 num
				FROM codes, (SELECT @n:=-1) tmp, (SELECT @rnum:=-1) tmp2
				LIMIT 7 ) vt
			LEFT OUTER JOIN (SELECT 
								reg_date
							FROM 
								log
							WHERE
								category_no=4 AND target_no=#{value} AND behavior=1) lg
						ON date = date(reg_date)
		GROUP BY
			date
		ORDER BY 
			date DESC
	</select>
	
	<select id="getWeeklyVisitors" parameterType="int" resultType="map">
		SELECT
			num, COUNT(reg_date) weekcount
		FROM
			( SELECT week(current_date()-7*(@n:=@n+1)) week, @rnum:=@rnum+1 num
				FROM codes, (SELECT @n:=-1) tmp, (SELECT @rnum:=-1) tmp2
				LIMIT 7 ) vt
			LEFT OUTER JOIN (SELECT 
								reg_date
							FROM 
								log
							WHERE
								category_no=4 AND target_no=#{value} AND behavior=1) lg
						ON week = week(reg_date)
		GROUP BY
			week
		ORDER BY 
			week DESC
	</select>
	
	

	<sql id="tagWiring">
		SELECT
			tg.tag_group_no, tg.tag_no, t.tag_name, tg.target_no
		FROM
			tag_group tg, tag t
		WHERE
			tg.tag_no = t.tag_no AND tg.category_no = 5
	</sql>
	
	<sql id="viewCount">
		SELECT
			count(*) count, target_no
		FROM
			log
		WHERE
			category_no = 4 AND behavior = 1
		GROUP BY
			target_no
	</sql>

</mapper>